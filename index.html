Index.html

<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wagenliste PWA</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #007aff; --bg: #f2f2f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-bottom: 100px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 8px; width: 100%; font-size: 16px; font-weight: bold; cursor: pointer; }
        .secondary { background: #34c759; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; font-size: 10px; }
        th, td { border: 1px solid black; padding: 4px; text-align: center; }
        .hidden { display: none; }
        @media print { .no-print { display: none; } body { background: white; padding: 0; } }
    </style>
</head>
<body>

<div id="view-meta" class="card no-print">
    <h2>Zug-Kopfdaten</h2>
    <input type="text" id="m_zug" placeholder="Zugnummer">
    <input type="text" id="m_stelle" placeholder="Betriebsstelle">
    <input type="text" id="m_erfasser" placeholder="Erfasser" value="DEIN NAME">
    <select id="m_fahrplan">
        <option value="">Fahrplan wählen (P/G)</option>
        <option value="P">P (Personenzug-Modus)</option>
        <option value="G">G (Güterzug-Modus)</option>
    </select>
    <button onclick="showWagons()">Wagenerfassung starten</button>
</div>

<div id="view-wagons" class="card no-print hidden">
    <h3 id="w_index">Wagen 1</h3>
    <input type="number" id="w_nr" placeholder="Wagennummer (12 Stellen)">
    <input type="text" id="w_gattung" placeholder="Gattung">
    <input type="number" step="0.1" id="w_len" placeholder="Länge (z.B. 14.7)">
    <input type="number" id="w_gesamt" placeholder="Gesamtgewicht (t)">
    <input type="number" id="w_bremse" placeholder="Bremsgewicht (t)">
    <button onclick="addWagon()">Nächster Wagen</button>
    <button class="secondary" onclick="calculateFinal()">Liste abschließen</button>
</div>

<div id="print-area"></div>

<script>
    let wagonList = [];
    let meta = {};

    function showWagons() {
        meta.zug = document.getElementById('m_zug').value;
        meta.erfasser = document.getElementById('m_erfasser').value;
        meta.stelle = document.getElementById('m_stelle').value;
        meta.fahrplan = document.getElementById('m_fahrplan').value;

        if (!meta.fahrplan) { alert("Bitte Fahrplan P oder G wählen!"); return; }
        document.getElementById('view-meta').classList.add('hidden');
        document.getElementById('view-wagons').classList.remove('hidden');
    }

    function addWagon() {
        let w = {
            nr: document.getElementById('w_nr').value,
            gattung: document.getElementById('w_gattung').value.toUpperCase(),
            len: parseFloat(document.getElementById('w_len').value) || 0,
            gesamt: Math.floor(parseFloat(document.getElementById('w_gesamt').value) || 0),
            bremse: Math.floor(parseFloat(document.getElementById('w_bremse').value) || 0)
        };
        wagonList.push(w);
        document.getElementById('w_nr').value = '';
        document.getElementById('w_index').innerText = "Wagen " + (wagonList.length + 1);
    }

    async function calculateFinal() {
        if (wagonList.length === 0) return;
        
        let totalWeight = wagonList.reduce((sum, w) => sum + w.gesamt, 0);
        let totalLen = wagonList.reduce((sum, w) => sum + w.len, 0);
        let totalBrakeP = wagonList.reduce((sum, w) => sum + w.bremse, 0);
        let totalBrakeG = 0;

        // Logik: Schwerer Güterzug (>= 1200t)
        if (meta.fahrplan === "P" && totalWeight >= 1200) {
            let choice = confirm("Schwerer Zug (>= 1200t). 5 Wagen auf G umstellen? (OK = 5 Wagen, Abbrechen = 3 Wagen)");
            let limit = choice ? 5 : 3;
            let actual = Math.min(limit, wagonList.length);
            let shifted = 0;
            for(let i=0; i<actual; i++) {
                shifted += wagonList[i].bremse;
            }
            totalBrakeP -= shifted;
            let gDed = (totalLen >= 700) ? 0.2875 : 0.25;
            totalBrakeG = Math.floor(shifted * (1 - gDed));
        }

        // P-Abzüge nach Länge
        let pDed = (totalLen >= 700) ? 0.19 : (totalLen >= 600 ? 0.10 : (totalLen >= 500 ? 0.05 : 0));
        totalBrakeP = Math.floor(totalBrakeP * (1 - pDed));

        if (meta.fahrplan === "G") {
            totalBrakeG = Math.floor(wagonList.reduce((sum, w) => sum + w.bremse, 0) * (totalLen >= 700 ? 0.95 : 1));
            totalBrakeP = 0;
        }

        renderHTML(totalWeight, totalLen, totalBrakeP, totalBrakeG);
    }

    function renderHTML(tw, tl, bp, bg) {
        let html = `<h1>Wagenliste Zug ${meta.zug}</h1>`;
        html += `<p>Erfasser: ${meta.erfasser} | Stelle: ${meta.stelle} | Fahrplan: ${meta.fahrplan}</p>`;
        html += `<table><tr><th>Nr.</th><th>Gattung</th><th>Gewicht</th><th>Bremse</th></tr>`;
        wagonList.forEach((w, i) => {
            html += `<tr><td>${i+1}</td><td>${w.gattung}</td><td>${w.gesamt}</td><td>${w.bremse}</td></tr>`;
        });
        html += `<tr><td><b>Summe</b></td><td>-</td><td><b>${tw} t</b></td><td><b>P:${bp} G:${bg}</b></td></tr></table>`;
        html += `<button class="no-print" onclick="window.location.reload()">Neue Liste</button>`;
        
        document.getElementById('view-wagons').classList.add('hidden');
        document.getElementById('print-area').innerHTML = html;
        window.print();
    }
</script>
<script>if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }</script>
</body>
</html>
